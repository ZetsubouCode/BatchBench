<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ config.APP_NAME or "BatchBench" }}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="icon" href="{{ url_for('static', filename='icons/icon.ico') }}">
  <style>
    :root{
      --bb-bg:#0b1220; --bb-card:#0f172a; --bb-border:#1f2a44;
      --bb-text:#e6edf3; --bb-muted:#a9bbcf;
      --bb-link:#79c0ff; --bb-link-hover:#a5d6ff;
      --bb-input-bg:#0b1220; --bb-input-bd:#3b4b6b; --bb-input-ph:#c4d2e1;
      --bb-primary:#3b82f6; --bb-primary-hover:#2563eb;
      --bb-code-bg:#0a1020; --bb-code-bd:#23314f; --bb-focus:#8ab4ff;

      --bs-body-bg:var(--bb-bg); --bs-body-color:var(--bb-text);
      --bs-heading-color:var(--bb-text); --bs-secondary-color:var(--bb-muted);
      --bs-tertiary-color:var(--bb-muted); --bs-border-color:var(--bb-border);
    }
    body{background:var(--bb-bg);color:var(--bb-text);}
    .navbar,.card{background:var(--bb-card);border:1px solid var(--bb-border);}
    .navbar .navbar-brand{color:var(--bb-text);}
    h1,h2,h3,h4,h5,h6,p,li,label{color:var(--bb-text);}
    .text-muted,.text-body-secondary,.small-note{color:var(--bb-muted)!important;}
    a{color:var(--bb-link);} a:hover,a:focus{color:var(--bb-link-hover);}
    .form-control,.form-select{background:var(--bb-input-bg);color:var(--bb-text);border-color:var(--bb-input-bd);}
    .form-control::placeholder{color:var(--bb-input-ph);opacity:1;}
    .form-select option{background:var(--bb-input-bg);color:var(--bb-text);}
    .btn-primary{background:var(--bb-primary);border-color:var(--bb-primary);}
    .btn-primary:hover,.btn-primary:focus{background:var(--bb-primary-hover);border-color:var(--bb-primary-hover);}
    pre{background:var(--bb-code-bg);color:var(--bb-text);padding:1rem;border-radius:.5rem;border:1px solid var(--bb-code-bd);overflow-x:auto;}
    :focus-visible{outline:2px solid var(--bb-focus);outline-offset:2px;}
    .list-group-item{background:var(--bb-card);color:var(--bb-text);border-color:var(--bb-border);}

    /* Tabs: white by default, blue when hover/focus/active */
    .nav-tabs .nav-link{color:var(--bb-text);}
    .nav-tabs .nav-link:hover,
    .nav-tabs .nav-link:focus,
    .nav-tabs .nav-link:focus-visible{color:var(--bb-link-hover);}
    .nav-tabs .nav-link.active{color:var(--bb-link); background:transparent; border-color: var(--bb-border) var(--bb-border) transparent;}

    /* Tooltips: force white text on dark bg */
    .tooltip{
      --bs-tooltip-bg:#0f172a;
      --bs-tooltip-color:#ffffff;
      --bs-tooltip-opacity:1;
      --bs-tooltip-arrow-color:#0f172a;
    }
    .tooltip .tooltip-inner{
      background-color:var(--bs-tooltip-bg);
      color:var(--bs-tooltip-color);
      border:1px solid var(--bb-border);
    }
    /* Busy overlay */
    #bb-busy{
      position:fixed; inset:0; display:none;
      align-items:center; justify-content:center;
      background:rgba(11,18,32,0.78);
      z-index:2000;
    }
    #bb-busy.show{display:flex;}
    #bb-busy .bb-busy-box{
      background:var(--bb-card);
      border:1px solid var(--bb-border);
      padding:1.5rem 2rem;
      border-radius:.75rem;
      box-shadow:0 10px 40px rgba(0,0,0,0.45);
      min-width:260px;
      text-align:center;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark mb-4">
    <div class="container">
      <a class="navbar-brand" href="/">{{ config.APP_NAME or "BatchBench" }}</a>
    </div>
  </nav>

  <div class="container pb-5">
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert alert-info">{% for m in messages %}<div>{{ m }}</div>{% endfor %}</div>
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
  </div>

  <!-- Folder Picker Modal -->
  <div class="modal fade" id="folderPicker" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content" style="background:var(--bb-card);color:var(--bb-text);border:1px solid var(--bb-border);">
        <div class="modal-header">
          <h5 class="modal-title">Choose a folder</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex gap-2 mb-2">
            <button class="btn btn-sm btn-secondary" id="bb-up" data-bs-toggle="tooltip" data-bs-title="Go up one level">Up</button>
            <div class="flex-grow-1">
              <input id="bb-current" class="form-control form-control-sm" readonly data-bs-toggle="tooltip" data-bs-title="Current path">
            </div>
          </div>
          <ul id="bb-list" class="list-group small"></ul>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" id="bb-select">Use this folder</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Busy overlay -->
  <div id="bb-busy" class="d-none" aria-live="polite" aria-busy="true">
    <div class="bb-busy-box">
      <div class="spinner-border text-light mb-3" role="status"></div>
      <div id="bb-busy-msg">Working...</div>
      <div class="small text-muted mt-2">Please wait â€” this can take a bit.</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Shared state for folder picker
    let bbTargetInput = null;
    let bbPath = "";

    async function bbGet(url){ const r = await fetch(url); return await r.json(); }

    async function bbShowDrives(){
      const data = await bbGet("/api/drives");
      const list = document.getElementById("bb-list"); list.innerHTML = "";
      document.getElementById("bb-current").value = "(choose a drive)";
      (data.drives||[]).forEach(d=>{
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.textContent = d;
        li.style.cursor="pointer";
        li.onclick = ()=> bbOpen(d);
        list.appendChild(li);
      });
      bbPath = "";
    }

    async function bbOpen(path){
      const data = await bbGet("/api/list-dir?path="+encodeURIComponent(path));
      bbPath = data.path || path;
      document.getElementById("bb-current").value = bbPath;
      const list = document.getElementById("bb-list"); list.innerHTML = "";
      (data.dirs||[]).forEach(p=>{
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.textContent = p;
        li.style.cursor="pointer";
        li.onclick = ()=> bbOpen(p);
        list.appendChild(li);
      });
      document.getElementById("bb-up").onclick = ()=> bbOpen(data.parent || path);
    }

    function bbNotifyInputChange(input){
      if(!input) return;
      input.dispatchEvent(new Event("input", { bubbles: true }));
      input.dispatchEvent(new Event("change", { bubbles: true }));
    }

    document.addEventListener("click", (e)=>{
      const btn = e.target.closest(".btn-browse");
      if(!btn) return;
      const targetId = btn.getAttribute("data-target");
      bbTargetInput = document.getElementById(targetId);
      const modal = new bootstrap.Modal(document.getElementById("folderPicker"));
      modal.show();
      bbShowDrives();
      document.getElementById("bb-select").onclick = ()=>{
        if(bbTargetInput && bbPath){
          bbTargetInput.value = bbPath;
          bbNotifyInputChange(bbTargetInput);
        }
        modal.hide();
      };
    });

    // On DOM ready: tooltips, busy indicator, and form persistence
    document.addEventListener("DOMContentLoaded", () => {
      // Tooltips
      document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
        new bootstrap.Tooltip(el);
      });

      const busy = document.getElementById("bb-busy");
      const busyMsg = document.getElementById("bb-busy-msg");
      const showBusy = (msg) => {
        if(!busy) return;
        busyMsg.textContent = msg || "Working...";
        busy.classList.remove("d-none");
        busy.classList.add("show");
      };
      const hideBusy = () => {
        if(!busy) return;
        busy.classList.add("d-none");
        busy.classList.remove("show");
      };
      window.bbBusy = { show: showBusy, hide: hideBusy };

      const persistForm = (form, key) => {
        if(!key) return;
        const storageKey = `bb-form-${key}`;
        const fields = Array.from(form.querySelectorAll("input,select,textarea")).filter(el=>{
          const t = (el.type||"").toLowerCase();
          return !el.disabled && !el.readOnly && t !== "hidden" && t !== "button" && t !== "submit" && !el.hasAttribute("data-no-persist");
        });

        try {
          const saved = JSON.parse(localStorage.getItem(storageKey) || "{}");
          fields.forEach(el=>{
            const name = el.name || el.id;
            if(!name || !(name in saved)) return;
            if((el.type||"").toLowerCase() === "checkbox"){
              el.checked = !!saved[name];
            }else{
              el.value = saved[name];
            }
          });
        } catch(e){}

        const save = () => {
          const data = {};
          fields.forEach(el=>{
            const name = el.name || el.id;
            if(!name) return;
            if((el.type||"").toLowerCase() === "checkbox"){
              data[name] = el.checked;
            }else{
              data[name] = el.value;
            }
          });
          try { localStorage.setItem(storageKey, JSON.stringify(data)); } catch(e){}
        };

        form.addEventListener("input", save);
        form.addEventListener("change", save);
      };

      document.querySelectorAll("form").forEach(form=>{
        const toolInput = form.querySelector('input[name="tool"]');
        const toolKey = toolInput ? (toolInput.value || "").trim() : "";
        if(toolKey && !form.hasAttribute("data-no-persist")){ persistForm(form, toolKey); }

        if(!form.hasAttribute("data-no-busy")){
          form.addEventListener("submit", ()=>{
            const label = form.getAttribute("data-tool-label") || toolKey || "task";
            showBusy(`Working on ${label}...`);
            form.querySelectorAll('button[type="submit"],button:not([type])').forEach(btn=>{
              btn.dataset.originalText = btn.innerHTML;
              btn.disabled = true;
              btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Working...';
            });
          });
        }
      });

      // Shared root folder default across tabs
      const rootKey = "bb-default-root";
      const rootInputs = Array.from(document.querySelectorAll('input[data-root-sync="1"]'));
      const trimPath = (val)=> (val || "").trim();
      let sharedRoot = trimPath(localStorage.getItem(rootKey));
      let rootSyncLocked = false;

      const setSharedRoot = (value, origin)=>{
        const next = trimPath(value);
        if(!next || next === sharedRoot) return;
        const prev = sharedRoot;
        sharedRoot = next;
        try { localStorage.setItem(rootKey, next); } catch(e){}
        rootSyncLocked = true;
        rootInputs.forEach(input=>{
          if(input === origin) return;
          const cur = trimPath(input.value);
          if(!cur || cur === prev){
            input.value = next;
            bbNotifyInputChange(input);
          }
        });
        rootSyncLocked = false;
      };

      const seedSharedRoot = ()=>{
        if(sharedRoot) return;
        const found = rootInputs.map(input=> trimPath(input.value)).find(val=> val);
        if(found){
          sharedRoot = found;
          try { localStorage.setItem(rootKey, found); } catch(e){}
        }
      };

      const applySharedRoot = ()=>{
        if(!sharedRoot) return;
        rootInputs.forEach(input=>{
          if(!trimPath(input.value)){
            input.value = sharedRoot;
            bbNotifyInputChange(input);
          }
        });
      };

      seedSharedRoot();
      applySharedRoot();

      rootInputs.forEach(input=>{
        const handler = ()=>{
          if(rootSyncLocked) return;
          setSharedRoot(input.value, input);
        };
        input.addEventListener("change", handler);
        input.addEventListener("blur", handler);
      });
    });
  </script>
</body>
</html>
