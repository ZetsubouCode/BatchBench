{% extends "base.html" %}
{% block content %}
  {% set tab = active_tab or 'webp' %}

  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item"><button class="nav-link {{ 'active' if tab=='webp' }}" data-bs-toggle="tab" data-bs-target="#tab-webp" type="button">Image -> PNG Converter</button></li>
    <li class="nav-item"><button class="nav-link {{ 'active' if tab=='batch' }}" data-bs-toggle="tab" data-bs-target="#tab-batch" type="button">Photo Adjust (preset)</button></li>
    <li class="nav-item"><button class="nav-link {{ 'active' if tab=='tags' }}" data-bs-toggle="tab" data-bs-target="#tab-tags" type="button">Dataset Tag Editor</button></li>
    <li class="nav-item"><button class="nav-link {{ 'active' if tab=='offline_tagger' }}" data-bs-toggle="tab" data-bs-target="#tab-offline-tagger" type="button">Offline Tagger (WD v3)</button></li>
    <li class="nav-item"><button class="nav-link {{ 'active' if tab=='normalize' }}" data-bs-toggle="tab" data-bs-target="#tab-normalize" type="button">Dataset Normalization</button></li>
    <li class="nav-item"><button class="nav-link {{ 'active' if tab=='combine' }}" data-bs-toggle="tab" data-bs-target="#tab-combine" type="button">Combine Dataset</button></li>
    <li class="nav-item"><button class="nav-link {{ 'active' if tab=='rename' }}" data-bs-toggle="tab" data-bs-target="#tab-rename" type="button">Flatten & Renumber</button></li>
    <li class="nav-item"><button class="nav-link {{ 'active' if tab=='merge' }}" data-bs-toggle="tab" data-bs-target="#tab-merge" type="button">Stitch Groups</button></li>
    <li class="nav-item"><button class="nav-link {{ 'active' if tab=='webtoon' }}" data-bs-toggle="tab" data-bs-target="#tab-webtoon" type="button">Webtoon Panel Splitter</button></li>
    <li class="nav-item"><button class="nav-link {{ 'active' if tab=='blur_brush' }}" data-bs-toggle="tab" data-bs-target="#tab-blur-brush" type="button">Brush Blur</button></li>
    <li class="nav-item"><button class="nav-link {{ 'active' if tab=='pipeline' }}" data-bs-toggle="tab" data-bs-target="#tab-pipeline" type="button">Pipeline (beta)</button></li>
    <li class="nav-item ms-auto {{ '' if tab=='batch' else 'd-none' }}" id="batch-preset-info">
      <span class="nav-link disabled">Presets loaded: {{ preset_names|length }}</span>
    </li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade {{ 'show active' if tab=='webp' }}" id="tab-webp">
      {% include "webp_to_png.html" %}
      {% if log and tab=='webp' %}
        <div class="card p-3 mt-3">
          <h5>Log</h5>
          <pre class="monospace">{{ log }}</pre>
        </div>
      {% endif %}
    </div>

    <div class="tab-pane fade {{ 'show active' if tab=='batch' }}" id="tab-batch">
      {% include "batch_adjust.html" %}
      {% if log and tab=='batch' %}
        <div class="card p-3 mt-3">
          <h5>Log</h5>
          <pre class="monospace">{{ log }}</pre>
        </div>
      {% endif %}
    </div>

    <div class="tab-pane fade {{ 'show active' if tab=='tags' }}" id="tab-tags">
      {% include "dataset_labeling.html" %}
    </div>

    <div class="tab-pane fade {{ 'show active' if tab=='offline_tagger' }}" id="tab-offline-tagger">
      {% include "offline_tagger.html" %}
      {% if log and tab=='offline_tagger' %}
        <div class="card p-3 mt-3">
          <h5>Log</h5>
          <pre class="monospace">{{ log }}</pre>
        </div>
      {% endif %}
    </div>

    <div class="tab-pane fade {{ 'show active' if tab=='normalize' }}" id="tab-normalize">
      {% include "normalize_dataset.html" %}
      {% if log and tab=='normalize' %}
        <div class="card p-3 mt-3">
          <h5>Log</h5>
          <pre class="monospace">{{ log }}</pre>
        </div>
      {% endif %}
    </div>

    <div class="tab-pane fade {{ 'show active' if tab=='combine' }}" id="tab-combine">
      {% include "combine_datasets.html" %}
      {% if log and tab=='combine' %}
        <div class="card p-3 mt-3">
          <h5>Log</h5>
          <pre class="monospace">{{ log }}</pre>
        </div>
      {% endif %}
    </div>
    
    <div class="tab-pane fade {{ 'show active' if tab=='rename' }}" id="tab-rename">
      {% include "group_renamer.html" %}
      {% if log and tab=='rename' %}
        <div class="card p-3 mt-3">
          <h5>Log</h5>
          <pre class="monospace">{{ log }}</pre>
        </div>
      {% endif %}
    </div>

    <div class="tab-pane fade {{ 'show active' if tab=='merge' }}" id="tab-merge">
      {% include "merge_groups.html" %}
      {% if log and tab=='merge' %}
        <div class="card p-3 mt-3">
          <h5>Log</h5>
          <pre class="monospace">{{ log }}</pre>
        </div>
      {% endif %}
    </div>

    <div class="tab-pane fade {{ 'show active' if tab=='webtoon' }}" id="tab-webtoon">
      {% include "webtoon_splitter.html" %}
      {% if log and tab=='webtoon' %}
        <div class="card p-3 mt-3">
          <h5>Log</h5>
          <pre class="monospace">{{ log }}</pre>
        </div>
      {% endif %}
    </div>

    <div class="tab-pane fade {{ 'show active' if tab=='blur_brush' }}" id="tab-blur-brush">
      {% include "blur_brush.html" %}
      {% if log and tab=='blur_brush' %}
        <div class="card p-3 mt-3">
          <h5>Log</h5>
          <pre class="monospace">{{ log }}</pre>
        </div>
      {% endif %}
    </div>

    <div class="tab-pane fade {{ 'show active' if tab=='pipeline' }}" id="tab-pipeline">
      {% include "pipeline.html" %}
      {% if log and tab=='pipeline' %}
        <div class="card p-3 mt-3">
          <h5>Log</h5>
          <pre class="monospace">{{ log }}</pre>
        </div>
      {% endif %}
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const infoEl = document.getElementById('batch-preset-info');
      if(!infoEl) return;

      const setInfoVisible = (target) => {
        infoEl.classList.toggle('d-none', target !== '#tab-batch');
      };

      const activeTab = document.querySelector('.nav-tabs [data-bs-toggle="tab"].active');
      setInfoVisible(activeTab?.getAttribute('data-bs-target') || '');

      document.querySelectorAll('.nav-tabs [data-bs-toggle="tab"]').forEach(btn => {
        btn.addEventListener('shown.bs.tab', (ev) => {
          setInfoVisible(ev.target?.getAttribute('data-bs-target') || '');
        });
      });
    });
  </script>

{% endblock %}

